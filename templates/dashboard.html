{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Horários{% endblock %}
{% block page_title %}Dashboard & Gerador de Horários{% endblock %}

{% block content %}
<div class="card-grid">
    <div class="card">
        <h2>1. Importar Dados (Opcional)</h2>
        <p class="card-subtitle">Use esta seção para popular o banco de dados rapidamente a partir de arquivos. Os dados existentes no sistema serão substituídos.</p>
        <form id="uploadForm" action="{{ url_for('upload_e_processar') }}" method="POST" enctype="multipart/form-data">
            <div class="file-input-wrapper">
                <label for="arquivoDisponibilidade">Arquivo de Disponibilidade:</label>
                <input type="file" id="arquivoDisponibilidade" name="arquivoDisponibilidade" accept=".csv,.xlsx" required>
            </div>
            <div class="file-input-wrapper">
                <label for="arquivoQuadroAulas">Arquivo com Quadro de Aulas:</label>
                <input type="file" id="arquivoQuadroAulas" name="arquivoQuadroAulas" accept=".csv,.xlsx" required>
            </div>
            <button type="submit" class="btn-principal"><i data-feather="upload"></i> Importar e Substituir Dados</button>
        </form>
    </div>

    <div class="card">
        <h2>2. Gerar Horário</h2>
        <p class="card-subtitle">Use os dados presentes no sistema (importados ou gerenciados manualmente) para gerar as melhores opções de horário.</p>
        <button id="btnGerarHorario" class="btn-secundario"><i data-feather="cpu"></i> Gerar 10 Melhores Opções</button>
    </div>
</div>

<div id="status" class="status-message" style="display: none;"></div>

<div class="card result-card" id="resultadoContainer" style="display: none;">
    <div class="resultado-header">
        <h2>3. Resultado</h2>
        <div class="seletor-wrapper">
            <label for="seletorOpcoes">Visualizar Opção:</label>
            <select id="seletorOpcoes"></select>
        </div>
    </div>
    <div id="horarioContainer" class="table-wrapper"></div>
    <div id="diagnosticoContainer">
        <h3>Aulas Não Alocadas nesta Opção:</h3>
        <ul id="listaNaoAlocadas"></ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnGerar = document.getElementById('btnGerarHorario');
    const statusDiv = document.getElementById('status');
    const resultadoContainer = document.getElementById('resultadoContainer');
    const seletorOpcoes = document.getElementById('seletorOpcoes');
    const horarioContainer = document.getElementById('horarioContainer');
    const listaNaoAlocadas = document.getElementById('listaNaoAlocadas');

    let todasOpcoes = []; // Armazena os resultados do backend

    btnGerar.addEventListener('click', async () => {
        // Mostra status de carregamento
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-message status-loading';
        statusDiv.innerHTML = '<i data-feather="loader"></i> Gerando horários, por favor aguarde...';
        feather.replace();
        resultadoContainer.style.display = 'none';
        btnGerar.disabled = true;

        try {
            const response = await fetch("{{ url_for('gerar_horario') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Erro desconhecido do servidor.');
            }

            // Sucesso!
            statusDiv.className = 'status-message status-success';
            statusDiv.innerHTML = '<i data-feather="check-circle"></i> Horários gerados com sucesso!';
            feather.replace();
            
            todasOpcoes = data.opcoes;
            popularSeletorOpcoes(todasOpcoes.length);
            exibirOpcao(0); // Exibe a primeira opção por padrão
            resultadoContainer.style.display = 'block';

        } catch (error) {
            statusDiv.className = 'status-message status-error';
            statusDiv.innerHTML = `<i data-feather="alert-triangle"></i> Falha ao gerar horários: ${error.message}`;
            feather.replace();
        } finally {
            btnGerar.disabled = false;
        }
    });

    function popularSeletorOpcoes(numOpcoes) {
        seletorOpcoes.innerHTML = '';
        for (let i = 0; i < numOpcoes; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Opção ${i + 1}`;
            seletorOpcoes.appendChild(option);
        }
    }

    seletorOpcoes.addEventListener('change', (e) => {
        exibirOpcao(parseInt(e.target.value));
    });

    function exibirOpcao(index) {
        const opcao = todasOpcoes[index];
        if (!opcao) return;

        horarioContainer.innerHTML = criarTabelaHTML(opcao.horario);

        listaNaoAlocadas.innerHTML = '';
        if (opcao.nao_alocadas && opcao.nao_alocadas.length > 0) {
            opcao.nao_alocadas.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.disciplina} (${item.professor}) - Faltam ${item.faltam_alocar} aulas.`;
                listaNaoAlocadas.appendChild(li);
            });
        } else {
            listaNaoAlocadas.innerHTML = '<li>Todas as aulas foram alocadas com sucesso nesta opção!</li>';
        }
    }

    function criarTabelaHTML(horario) {
        const dias = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'];
        const periodos = [1, 2, 3, 4, 5];
        let tabela = `<table class="schedule-table"><thead><tr><th>Período</th>`;
        dias.forEach(dia => tabela += `<th>${dia}</th>`);
        tabela += `</tr></thead><tbody>`;

        const grade = {};

        horario.forEach(aula => {
            if (!grade[aula.dia]) grade[aula.dia] = {};
            grade[aula.dia][aula.periodo] = `<strong>${aula.disciplina}</strong><br><small>${aula.professor}</small>`;
        });

        periodos.forEach(p => {
            tabela += `<tr><td>${p}ª Aula</td>`;
            dias.forEach(d => {
                tabela += `<td>${grade[d] && grade[d][p] ? grade[d][p] : ''}</td>`;
            });
            tabela += `</tr>`;
        });

        tabela += `</tbody></table>`;
        return tabela;
    }
});
</script>
{% endblock %}